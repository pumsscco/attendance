# PlutoChan
考勤数据分析项目，这是个范例项目，目的是用于各种计划使用的新技术的预先实践，因为这个项目数据模型最简单

## 文件说明

* 配置文件：config.yaml，这个文件包含所有的常量配置，诸如数据库，redis，端口，日志文件等等
数据库与其专用帐户名，均与该项目名相同，以本项目为例，均为attendance，而密码使用随机密码，
日志文件名则为attendance，监听地址中，端口从55755开始，本项目为55758,主机一律固定为localhost,
均配置在此配置文件中，方便未来需要时进行更改，而无需改动代码，此文件无须隐藏
* 数据库文件：attendance.sql，数据库的导出文件
方便在各环境中随时更新数据库，以应对数据库的结构变更，
各项目均有此文件，也不隐藏，没有什么特别隐私数据
* 主程序入口：main.go
* 模型文件：models.go
* 路由文件：routes.go
* 模板目录：templates
* 静态文件：static

## 页面
为简单起见，不用登录，首页纯静态，罗列全部可用链接，但仍保留嵌套模板设计，具体页面如下：

* index.html: 首页
* layout.html: 总布局页
* navbar.html: 导航条
* lastest.html: 最新记录专用页

## 数据有效性分析
由于是考勤数据，因此依据公司的考勤规则，它要符合以下需求

* 工作时间，多数公司是9点～18点，目前为9～17：30
* 每天一笔记录，这也就是说，插入数据前，必须先判断checkin与checkout的日期，不能在已有当日记录的情况下，再插入新的记录


## 测试
偷个懒，就不做业务逻辑的测试，只做压力测试，看自己的程序，在目前的架构下，效果如何


## 拾遗
总结一些开发过程中的经验教训：

* 输入的时间格式为**2006-01-02 15:04**，此为固定模式，不能随便输入，否则会出现时间解析错误
* 对于复杂的数据结构，存储到redis之前，先将其用json序列化，然后再存入，取出后，先反序列化，再使用，这样就实现了充分利用缓存的目的了
* 对于简单的数据结构，如列表，哈希表(go的map,python的dict,或是bash的associative array)，就充分利用redis内置的HSET/HGET功能
* 经研究，发现redis的内置类型，不能处理复杂的数据结构，因此只能将类似**map[string]float64**这样的类型，一样用json方式处理
* redis只对字符串比较好处理，其它最好别用redis，否则各种麻烦

## 上线
上线可以有多种模式，
### 传统虚拟化
最传统的方式，是上个虚拟机，如果图省事，包括应用，与后端的mysql/redis，都放一起，此情况下，本地虚拟机，还是云服务器，没什么区别
### docker-compose
第二种方式，上docker，以docker-compose来部署，实际上，这相当于测试环境

* 此方式如要完美实现，需要只使用一个docker-compose.yml文件，将所有工作均实现
* 第一步是实现数据库的数据库用户的创建，表的创建，与初始数据的导入，也包括配置文件的设置
* 第二步是实现redis的创建，主要是配置文件要在初始化时代入
* 最后一步，上应用，可以先上一个考勤项目，最终目标是要四个都上，因为四个用一套后端是合适的，尽管不提倡这样做
### k8s
第三种，是上**k8s**，最彻底，最专业的容器化，也是2020年的**重点研究对象**

* 可以用nfs等方式，模拟pv/pvc等模式
* 仅用minikube，小型化，省点资源
* 考虑用ingress来实现不同名称的解析，比如，将**pal4.plutochan.name**解析到**10.30.50.75**

5月6～9日四天的主要工作，就是把一键部署attendance容器环境的docker-compose.yml写出来

### 策略调整
考虑到网络因素等原因，暂时不考虑本地容器化部署，也即暂时放弃本地k8s部署，而将compose部署，放置在远程机器上，另外，增加本地生产环境部署

* 本地生产环境：使用与开发完全相同的mysql/redis配置，原因是该项目为个人项目，如若为公司开发，则不能如此了
* 远程docker环境：目前暂时放置在dlns-04机器上，也是目前研究的重点
* 本地开发环境：与原先无差异

除开发使用55758作为应用端口外，其它环境，均用5578作为端口，目前主要是避免位于本地的开发与生产环境端口冲突

* 目前的核心，是利用go build时的ldflags -X参数功能，为三种不同的环境，构建不一样的可执行文件
* 利用from scratch来大幅削减镜像大小，则是终极目标